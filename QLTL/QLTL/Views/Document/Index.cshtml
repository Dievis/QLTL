@model QLTL.ViewModels.DocumentVM.DocumentIndexVM
@{
    ViewBag.Title = "Danh sách tài liệu";
    var currentUserId = Session["UserId"] != null ? (int)Session["UserId"] : 0; // kiểm tra null

    var canDelete = false;
    var canEdit = false;
    var canCreate = false;

    if (Session["IsSuperAdmin"] is bool isSuperAdmin && isSuperAdmin)
    {
        canDelete = true;
        canEdit = true;
        canCreate = true;
    }
    else if (Session["Permissions"] is List<string> perms)
    {
        canDelete = perms.Contains("Document.Delete", StringComparer.OrdinalIgnoreCase);
        canEdit = perms.Contains("Document.Edit", StringComparer.OrdinalIgnoreCase);
        canCreate = perms.Contains("Document.Create", StringComparer.OrdinalIgnoreCase);
    }
}

@section styles {
    <link href="~/Content/index.css" rel="stylesheet" />
}

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header card-header-gradient d-flex justify-content-between align-items-center">
            <h2 class="mb-0 text-white">
                <i class="bi bi-journals me-2"></i>Danh sách tài liệu
            </h2>
            @if (canCreate)
            {
                <a href="@Url.Action("Create")" class="btn btn-light">
                    <i class="bi bi-plus-circle"></i> Thêm mới
                </a>
            }
        </div>

        <div class="card-body">
            <!-- Search + Filter -->
            <form method="get" class="row mb-3">
                <div class="col-md-4">
                    <input type="text" name="search" value="@Model.SearchTerm"
                           class="form-control" placeholder="Tìm kiếm..." />
                </div>
                <div class="col-md-3">
                    <select name="isDeleted" class="form-select">
                        <option value="">-- Tất cả trạng thái --</option>
                        <option value="false" @(Model.IsDeleted == false ? "selected" : "")>Hoạt động</option>
                        <option value="true" @(Model.IsDeleted == true ? "selected" : "")>Đã xóa</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-search-gradient">
                        <i class="bi bi-search"></i> Tìm kiếm
                    </button>
                </div>
            </form>

            <!-- Bảng dữ liệu -->
            <table class="table table-striped table-hover">
                <thead class="table-header-gradient">
                    <tr>
                        <th>Tiêu đề</th>
                        <th>Người tạo</th>
                        <th>Ngày tạo</th>
                        <th>Trạng thái</th>
                        <th>Tình trạng duyệt</th>
                        <th>File</th>
                        <th class="text-center">Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.Items)
                    {
                        <tr data-docid="@item.DocumentId">
                            <td>@item.Title</td>
                            <td>@item.UploaderName</td>
                            <td>@item.CreatedAt.ToString("dd/MM/yyyy")</td>
                            <td>
                                @if (item.IsDeleted)
                                {
                                    <span class="badge bg-danger">Đã xóa</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Hoạt động</span>
                                }
                            </td>
                            <td>
                                @if (string.IsNullOrEmpty(item.ApprovalStatus) || item.ApprovalStatus == "Pending")
                                {
                                    <span class="badge bg-warning text-dark">Đang chờ duyệt</span>
                                }
                                else if (item.ApprovalStatus == "Approved")
                                {
                                    <span class="badge bg-success">Đã duyệt</span>
                                }
                                else if (item.ApprovalStatus == "Rejected")
                                {
                                    <span class="badge bg-danger">Từ chối</span>
                                }
                            </td>
                            <td>
                                @if (!string.IsNullOrEmpty(item.FileName))
                                {
                                    var ext = System.IO.Path.GetExtension(item.FileName).ToLower();
                                    if (ext == ".pdf" || ext == ".png" || ext == ".jpg" || ext == ".jpeg")
                                    {
                                        <a href="@Url.Action("Download", "Document", new { id = item.DocumentId })" target="_blank" class="btn btn-sm btn-primary">
                                            <i class="bi bi-eye"></i> Xem
                                        </a>
                                    }
                                    else
                                    {
                                        <a href="@Url.Action("Download", "Document", new { id = item.DocumentId })" class="btn btn-sm btn-success">
                                            <i class="bi bi-download"></i> Tải
                                        </a>
                                    }
                                }
                            </td>
                            <td class="text-center">
                                <a href="@Url.Action("Details", new { id = item.DocumentId })" class="btn btn-sm btn-info" title="Xem chi tiết">
                                    <i class="bi bi-eye"></i>
                                </a>
                                @if (canEdit)
                                {
                                    <a href="@Url.Action("Edit", new { id = item.DocumentId })" class="btn btn-sm btn-warning" title="Sửa">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                }
                                @if (canDelete)
                                {
                                    using (Html.BeginForm("Delete", "Document", new { id = item.DocumentId }, FormMethod.Post, new { @class = "d-inline" }))
                                    {
                                        @Html.AntiForgeryToken()
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Bạn có chắc muốn xóa?');" title="Xóa">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    }
                                }
                                @if (currentUserId != 0)
                                {
                                    <button class="btn btn-sm btn-outline-danger favorite-btn" data-userid="@currentUserId" title="Yêu thích">
                                        <i class="bi bi-heart"></i> Yêu thích
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <!-- Phân trang -->
            <nav>
                <ul class="pagination">
                    @{
                        int totalPages = (int)Math.Ceiling((double)Model.TotalRecords / Model.PageSize);
                        for (int i = 1; i <= totalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageIndex ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", new { search = Model.SearchTerm, isDeleted = Model.IsDeleted, page = i })">@i</a>
                            </li>
                        }
                    }
                </ul>
            </nav>
        </div>
    </div>
</div>

@section Scripts{
    <script>
$(document).ready(function(){
    $('.favorite-btn').each(function(){
        var btn = $(this);
        var docId = btn.closest('tr').data('docid');
        var userId = btn.data('userid');

        $.get('@Url.Action("IsFavorite", "Document")', { documentId: docId, userId: userId }, function(res){
            if(res.isFavorite){
                btn.addClass('btn-danger').removeClass('btn-outline-danger');
                btn.html('<i class="bi bi-heart-fill"></i> Đã yêu thích');
            }
        });
    });

    $('.favorite-btn').click(function(){
        var btn = $(this);
        var docId = btn.closest('tr').data('docid');
        var userId = btn.data('userid');
        var isFav = btn.hasClass('btn-danger');

        if(isFav){
            $.post('@Url.Action("RemoveFavorite", "Document")', { documentId: docId, userId: userId }, function(res){
                if(res.success){
                    btn.removeClass('btn-danger').addClass('btn-outline-danger');
                    btn.html('<i class="bi bi-heart"></i> Yêu thích');
                } else {
                    alert(res.message);
                }
            });
        } else {
            $.post('@Url.Action("AddFavorite", "Document")', { documentId: docId, userId: userId }, function(res){
                if(res.success){
                    btn.addClass('btn-danger').removeClass('btn-outline-danger');
                    btn.html('<i class="bi bi-heart-fill"></i> Đã yêu thích');
                } else {
                    alert(res.message);
                }
            });
        }
    });
});
    </script>
}